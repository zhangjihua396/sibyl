# https://moonrepo.dev/docs/config/project
$schema: "https://moonrepo.dev/schemas/project.json"

# Root project for workspace-level tasks
language: other
type: configuration

tasks:
  # ==========================================================================
  # Development
  # ==========================================================================
  dev:
    command:
      'docker compose up -d && sleep 1 && npx concurrently --raw --kill-others-on-fail "uv run
      --directory apps/api sibyld serve --reload" "uv run --directory apps/api arq
      sibyl.jobs.worker.WorkerSettings --watch src" "moon run web:dev"'
    env:
      FORCE_COLOR: "1"
    local: true
    options:
      persistent: true
      shell: true

  dev-api:
    command: |
      docker compose up -d
      sleep 1
      uv run --directory apps/api sibyld serve --reload
    local: true
    options:
      persistent: true
      shell: true

  dev-web:
    command: "moon run web:dev"
    local: true
    options:
      persistent: true

  stop:
    command: |
      echo "ðŸ›‘ Stopping Sibyl services..."
      pkill -f "sibyl-serve" 2>/dev/null || true
      pkill -f "next dev" 2>/dev/null || true
      docker compose down
      echo "âœ“ All services stopped"
    local: true
    options:
      shell: true

  # ==========================================================================
  # Docker
  # ==========================================================================
  docker-up:
    command: "docker compose up -d"
    local: true

  docker-down:
    command: "docker compose down"
    local: true

  docker-logs:
    command: "docker compose logs -f"
    local: true
    options:
      persistent: true

  # ==========================================================================
  # Formatting (aggregates individual project tasks)
  # ==========================================================================
  format:
    command: "npx prettier --write '\\*.md' '\\*.yml' '\\*.yaml'"
    inputs:
      - "*.md"
      - "*.yml"
      - "*.yaml"
    local: true

  fmt:
    deps:
      - "root:format"
      - "docs:format"
      - "skills:format"
      - "infra:format"
    local: true

  fmt-check:
    deps:
      - "docs:lint"
      - "skills:lint"
      - "infra:lint"

  # ==========================================================================
  # E2E Testing
  # ==========================================================================
  e2e-up:
    command: "docker compose -f compose.e2e.yml up -d"
    local: true

  e2e-down:
    command: "docker compose -f compose.e2e.yml down -v"
    local: true

  # ==========================================================================
  # Python Environment
  # ==========================================================================
  sync:
    # Create venv if missing/corrupt, then sync
    command: "uv venv --allow-existing && uv sync"
    inputs:
      - "pyproject.toml"
      - "uv.lock"
    options:
      shell: true
