# https://moonrepo.dev/docs/config/project
$schema: "https://moonrepo.dev/schemas/project.json"

# Root project for workspace-level tasks
language: other
type: configuration

tasks:
  # ==========================================================================
  # Development
  # ==========================================================================
  dev:
    command:
      'docker compose up -d && sleep 1 && npx concurrently --kill-others-on-fail -n "api,worker,web"
      -c "magenta,yellow,cyan" "uv run --directory apps/api sibyld serve --reload" "uv run
      --directory apps/api arq sibyl.jobs.worker.WorkerSettings --watch src" "moon run web:dev"'
    local: true
    options:
      persistent: true

  dev-api:
    command: |
      docker compose up -d
      sleep 1
      uv run --directory apps/api sibyld serve --reload
    local: true
    options:
      persistent: true
      shell: true

  dev-web:
    command: "moon run web:dev"
    local: true
    options:
      persistent: true

  stop:
    command: |
      echo "ðŸ›‘ Stopping Sibyl services..."
      pkill -f "sibyl-serve" 2>/dev/null || true
      pkill -f "next dev" 2>/dev/null || true
      docker compose down
      echo "âœ“ All services stopped"
    local: true
    options:
      shell: true

  # ==========================================================================
  # Docker
  # ==========================================================================
  docker-up:
    command: "docker compose up -d"
    local: true

  docker-down:
    command: "docker compose down"
    local: true

  docker-logs:
    command: "docker compose logs -f"
    local: true
    options:
      persistent: true

  # ==========================================================================
  # Formatting (non-code files)
  # ==========================================================================
  fmt:
    command: "pnpm run fmt"
    local: true

  # ==========================================================================
  # Installation
  # ==========================================================================
  install:
    command: |
      echo "Installing sibyl CLI..."
      uv tool install ./apps/cli --force
      echo "Installing sibyld daemon..."
      uv tool install ./apps/api --force
      echo "Installing skills..."
      mkdir -p ~/.claude/skills ~/.codex/skills
      rm -rf ~/.claude/skills/sibyl-knowledge ~/.claude/skills/sibyl-project-manager
      rm -rf ~/.codex/skills/sibyl-knowledge ~/.codex/skills/sibyl-project-manager
      cp -r skills/sibyl-knowledge ~/.claude/skills/
      cp -r skills/sibyl-project-manager ~/.claude/skills/
      cp -r skills/sibyl-knowledge ~/.codex/skills/
      cp -r skills/sibyl-project-manager ~/.codex/skills/
      echo "âœ“ Installed sibyl, sibyld, and skills"
    local: true
    options:
      shell: true

  install-dev:
    command: |
      echo "Installing sibyl CLI (editable)..."
      uv tool install ./apps/cli --editable --force
      echo "Installing sibyld daemon (editable)..."
      uv tool install ./apps/api --editable --force
      echo "Installing skills..."
      mkdir -p ~/.claude/skills ~/.codex/skills
      rm -rf ~/.claude/skills/sibyl-knowledge ~/.claude/skills/sibyl-project-manager
      rm -rf ~/.codex/skills/sibyl-knowledge ~/.codex/skills/sibyl-project-manager
      cp -r skills/sibyl-knowledge ~/.claude/skills/
      cp -r skills/sibyl-project-manager ~/.claude/skills/
      cp -r skills/sibyl-knowledge ~/.codex/skills/
      cp -r skills/sibyl-project-manager ~/.codex/skills/
      echo "âœ“ Installed sibyl, sibyld (editable), and skills"
    local: true
    options:
      shell: true

  install-skills:
    command: |
      mkdir -p ~/.claude/skills ~/.codex/skills
      rm -rf ~/.claude/skills/sibyl-knowledge ~/.claude/skills/sibyl-project-manager
      rm -rf ~/.codex/skills/sibyl-knowledge ~/.codex/skills/sibyl-project-manager
      cp -r skills/sibyl-knowledge ~/.claude/skills/
      cp -r skills/sibyl-project-manager ~/.claude/skills/
      cp -r skills/sibyl-knowledge ~/.codex/skills/
      cp -r skills/sibyl-project-manager ~/.codex/skills/
      echo "âœ“ Installed to ~/.claude/skills and ~/.codex/skills"
    local: true

  # ==========================================================================
  # E2E Testing
  # ==========================================================================
  e2e-up:
    command: "docker compose -f compose.e2e.yml up -d"
    local: true

  e2e-down:
    command: "docker compose -f compose.e2e.yml down -v"
    local: true
