# https://moonrepo.dev/docs/config/project
$schema: "https://moonrepo.dev/schemas/project.json"

# Root project for workspace-level tasks
language: other
type: configuration

tasks:
  # ==========================================================================
  # Development
  # ==========================================================================
  dev:
    command:
      'docker compose up -d && sleep 1 && npx concurrently --raw --kill-others-on-fail "uv run
      --directory apps/api sibyld serve --reload" "uv run --directory apps/api arq
      sibyl.jobs.worker.WorkerSettings --watch src" "moon run web:dev"'
    env:
      FORCE_COLOR: "1"
    local: true
    options:
      persistent: true
      shell: true

  dev-api:
    command: |
      docker compose up -d
      sleep 1
      uv run --directory apps/api sibyld serve --reload
    local: true
    options:
      persistent: true
      shell: true

  dev-web:
    command: "moon run web:dev"
    local: true
    options:
      persistent: true

  stop:
    command: |
      echo "üõë Stopping Sibyl services..."
      pkill -f "sibyl-serve" 2>/dev/null || true
      pkill -f "next dev" 2>/dev/null || true
      docker compose down
      echo "‚úì All services stopped"
    local: true
    options:
      shell: true

  # ==========================================================================
  # Docker
  # ==========================================================================
  docker-up:
    command: "docker compose up -d"
    local: true

  docker-down:
    command: "docker compose down"
    local: true

  docker-logs:
    command: "docker compose logs -f"
    local: true
    options:
      persistent: true

  # ==========================================================================
  # Quickstart (uses GHCR images - same as end-users)
  # ==========================================================================
  quickstart:
    command: |
      if [ ! -f .env.quickstart ]; then
        echo "‚ö†Ô∏è  Create .env.quickstart with your API keys first"
        echo "   cp .env.quickstart.example .env.quickstart"
        exit 1
      fi
      docker compose -f docker-compose.quickstart.yml --env-file .env.quickstart up -d
      echo ""
      echo "üöÄ Sibyl quickstart running!"
      echo "   Web UI:   http://localhost:${SIBYL_WEB_PORT:-3337}"
      echo "   API:      http://localhost:${SIBYL_SERVER_PORT:-3334}"
      echo "   Graph UI: http://localhost:${SIBYL_FALKORDB_BROWSER_PORT:-3335}"
    local: true
    options:
      shell: true

  quickstart-stop:
    command: "docker compose -f docker-compose.quickstart.yml down"
    local: true

  quickstart-logs:
    command: "docker compose -f docker-compose.quickstart.yml logs -f"
    local: true
    options:
      persistent: true

  # Test instance (runs alongside dev on different ports)
  quickstart-test:
    command: |
      if [ ! -f .env.quickstart ]; then
        echo "‚ö†Ô∏è  Create .env.quickstart with your API keys first"
        exit 1
      fi
      docker compose -f docker-compose.quickstart.yml -f docker-compose.quickstart.test.yml --env-file .env.quickstart up -d
      echo ""
      echo "üß™ Sibyl TEST instance running (separate from dev)!"
      echo "   Web UI:   http://localhost:3347"
      echo "   API:      http://localhost:3344"
      echo "   Graph UI: http://localhost:3345"
    local: true
    options:
      shell: true

  quickstart-test-stop:
    command:
      "docker compose -f docker-compose.quickstart.yml -f docker-compose.quickstart.test.yml down"
    local: true

  quickstart-test-logs:
    command:
      "docker compose -f docker-compose.quickstart.yml -f docker-compose.quickstart.test.yml logs -f"
    local: true
    options:
      persistent: true

  quickstart-pull:
    command: "docker compose -f docker-compose.quickstart.yml pull"
    local: true

  # ==========================================================================
  # Formatting (aggregates individual project tasks)
  # ==========================================================================
  format:
    command: "npx prettier --write '\\*.md' '\\*.yml' '\\*.yaml'"
    inputs:
      - "*.md"
      - "*.yml"
      - "*.yaml"
    local: true

  fmt:
    deps:
      - "root:format"
      - "docs:format"
      - "skills:format"
      - "infra:format"
    local: true

  fmt-check:
    deps:
      - "docs:lint"
      - "skills:lint"
      - "infra:lint"

  # ==========================================================================
  # Coverage
  # ==========================================================================
  coverage:
    deps:
      - "api:test-cov"
      - "cli:test-cov"
      - "core:test-cov"
      - "web:test-cov"

  # ==========================================================================
  # E2E Testing
  # ==========================================================================
  e2e-up:
    command: "docker compose -f compose.e2e.yml up -d"
    local: true

  e2e-down:
    command: "docker compose -f compose.e2e.yml down -v"
    local: true

  # ==========================================================================
  # Python Environment
  # ==========================================================================
  sync:
    # Create venv if missing/corrupt, then sync
    command: "uv sync"
    options:
      shell: true
