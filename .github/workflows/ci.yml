name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest

    services:
      falkordb:
        image: falkordb/falkordb:latest
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5

      postgres:
        image: pgvector/pgvector:pg18
        ports:
          - 5433:5432
        env:
          POSTGRES_USER: sibyl_ci
          POSTGRES_PASSWORD: sibyl_ci_password
          POSTGRES_DB: sibyl_ci
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    env:
      SIBYL_ENVIRONMENT: production
      SIBYL_JWT_SECRET: test-secret-for-ci
      SIBYL_FALKORDB_HOST: localhost
      SIBYL_FALKORDB_PORT: 6380
      SIBYL_FALKORDB_PASSWORD: ""
      SIBYL_POSTGRES_HOST: localhost
      SIBYL_POSTGRES_PORT: 5433
      SIBYL_POSTGRES_USER: sibyl_ci
      SIBYL_POSTGRES_PASSWORD: sibyl_ci_password
      SIBYL_POSTGRES_DB: sibyl_ci
      SIBYL_OPENAI_API_KEY: sk-test-key
      SIBYL_ANTHROPIC_API_KEY: sk-ant-test-key
      SIBYL_MOCK_LLM: true

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # =========================================================================
      # System Dependencies
      # =========================================================================
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libxslt-dev

      # =========================================================================
      # Moonrepo Toolchain (proto + moon + all tools)
      # =========================================================================
      - name: Setup moonrepo toolchain
        uses: moonrepo/setup-toolchain@v0.6
        with:
          auto-install: true

      - name: Fix proto shim permissions
        run: |
          if [ -d "$HOME/.proto/shims" ]; then
            chmod +x "$HOME/.proto/shims"/* 2>/dev/null || true
          fi
          if [ -d "$HOME/.proto/bin" ]; then
            chmod +x "$HOME/.proto/bin"/* 2>/dev/null || true
          fi

      # =========================================================================
      # Caching
      # =========================================================================
      - name: Cache moon outputs
        uses: actions/cache@v5
        with:
          path: |
            .moon/cache
            apps/api/.venv
            apps/web/node_modules
            apps/web/.next/cache
          key:
            moon-${{ runner.os }}-${{ hashFiles('.prototools', 'apps/api/uv.lock',
            'apps/web/pnpm-lock.yaml') }}
          restore-keys: |
            moon-${{ runner.os }}-

      # =========================================================================
      # Lint & Typecheck (all projects in parallel via moon)
      # =========================================================================
      - name: Lint
        run: moon ci :lint

      - name: Typecheck
        run: moon ci :typecheck

      # =========================================================================
      # Build (all projects)
      # =========================================================================
      - name: Build
        run: moon ci :build

      - name: Build Storybook
        run: moon run web:build-storybook

      # =========================================================================
      # Database Setup
      # =========================================================================
      - name: Run database migrations
        run: moon run api:db-migrate

      # =========================================================================
      # Unit Tests
      # =========================================================================
      - name: Run unit tests
        run: |
          cd apps/api
          uv run pytest --ignore=tests/e2e --cov=src --cov-report=xml --cov-report=term -v

      # =========================================================================
      # E2E Tests
      # =========================================================================
      - name: Start backend server
        run: |
          cd apps/api
          uv run sibyld serve &
          echo "Waiting for backend to start..."
          for i in {1..60}; do
            if curl -s http://localhost:3334/api/health > /dev/null; then
              echo "Backend is ready!"
              sleep 2
              break
            fi
            echo "Attempt $i: Backend not ready yet..."
            sleep 1
          done
          curl -s http://localhost:3334/api/health | head -c 200

      - name: Start background job worker
        run: |
          cd apps/api
          uv run sibyld worker &
          echo "Background job worker started"
          sleep 2

      - name: Start frontend server
        run: |
          cd apps/web
          pnpm start &
          echo "Waiting for frontend to start..."
          for i in {1..60}; do
            if curl -s http://localhost:3337 > /dev/null 2>&1; then
              echo "Frontend is ready!"
              break
            fi
            echo "Attempt $i: Frontend not ready yet..."
            sleep 1
          done

      - name: Run e2e tests
        run: |
          cd apps/e2e
          uv run pytest -v

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          echo "=== Backend server logs ==="
          curl -s http://localhost:3334/api/health || echo "Backend not responding"
          echo ""
          echo "=== FalkorDB graph contents ==="
          docker exec $(docker ps -q --filter ancestor=falkordb/falkordb:latest) redis-cli GRAPH.QUERY default "MATCH (n) RETURN labels(n), count(*) LIMIT 10" 2>/dev/null || echo "Could not query FalkorDB"

      # =========================================================================
      # Upload Artifacts
      # =========================================================================
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: apps/api/coverage.xml
          fail_ci_if_error: false

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: apps/api/dist/
