# https://moonrepo.dev/docs/config/project
$schema: "https://moonrepo.dev/schemas/project.json"

language: python
type: application
platform: system

fileGroups:
  sources:
    - "src/**/*"
  tests:
    - "tests/**/*"
  configs:
    - "pyproject.toml"
    - "alembic.ini"

tasks:
  # Linting & Formatting
  lint:
    command: "uv run ruff check src tests"
    deps:
      - "root:sync"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
      - "@group(configs)"

  format:
    command: "uv run ruff format src tests"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
    local: true

  fix:
    command: "uv run ruff check --fix src tests && uv run ruff format src tests"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
    local: true

  fix-all:
    command: "uv run ruff check --fix --unsafe-fixes src tests && uv run ruff format src tests"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
    local: true

  # Type Checking
  typecheck:
    command: "uv run pyright"
    deps:
      - "root:sync"
    inputs:
      - "@group(sources)"
      - "@group(configs)"

  # Testing (unit tests only - e2e tests are in apps/e2e)
  test:
    command: "uv run pytest"
    deps:
      - "root:sync"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
    options:
      envFile: ".env"

  test-cov:
    command: "uv run pytest --cov=src --cov-report=term-missing --cov-report=xml:coverage.xml"
    deps:
      - "root:sync"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
    outputs:
      - "coverage.xml"
    options:
      envFile: ".env"

  # Server
  serve:
    command: "uv run sibyld serve"
    local: true
    options:
      envFile: ".env"
      persistent: true

  # Worker
  worker:
    command: "uv run sibyld worker"
    local: true
    options:
      envFile: ".env"
      persistent: true

  # Database
  db-migrate:
    command: "uv run alembic upgrade head"
    local: true
    options:
      envFile: ".env"

  db-revision:
    command: "uv run alembic revision --autogenerate"
    local: true
    options:
      envFile: ".env"

  # Dependencies
  sync:
    command: "uv sync"
    inputs:
      - "pyproject.toml"
      - "uv.lock"

  # Build
  build:
    command: "uv build"
    inputs:
      - "@group(sources)"
      - "@group(configs)"

  # Installation
  install:
    command: "uv tool install . --force"
    local: true

  install-dev:
    command: "uv tool install . --editable --force"
    local: true
