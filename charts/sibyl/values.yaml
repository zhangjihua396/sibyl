# Sibyl Helm Chart Values
# This chart deploys the Sibyl application (backend + frontend + worker)
# It does NOT include infrastructure (PostgreSQL, FalkorDB, Kong)
# Those should be deployed separately using their respective charts

# -- Global settings
global:
  # -- Image pull secrets for private registries
  imagePullSecrets: []

# -- Database migrations configuration
migrations:
  # -- Enable migration job (runs as pre-upgrade/pre-install hook)
  enabled: true
  # -- Number of retries before marking migration as failed
  backoffLimit: 3
  # -- Seconds to keep completed job before cleanup
  ttlSecondsAfterFinished: 600

# -- Backend configuration
backend:
  # -- Number of replicas (ignored if autoscaling is enabled)
  replicaCount: 1

  image:
    # -- Backend image repository
    repository: ghcr.io/hyperb1iss/sibyl
    # -- Image pull policy
    pullPolicy: IfNotPresent
    # -- Image tag (defaults to chart appVersion)
    tag: ""

  # -- Service configuration
  service:
    type: ClusterIP
    port: 3334
    # -- Service annotations
    annotations: {}
    # -- Session affinity for MCP stateful connections
    # Set to "ClientIP" to enable sticky sessions (recommended for multi-replica)
    sessionAffinity: ""
    # -- Session affinity config (only used if sessionAffinity is set)
    sessionAffinityConfig:
      clientIP:
        timeoutSeconds: 10800 # 3 hours

  # -- Autoscaling configuration
  autoscaling:
    # -- Enable horizontal pod autoscaler
    enabled: false
    # -- Minimum replicas
    minReplicas: 2
    # -- Maximum replicas
    maxReplicas: 10
    # -- Target CPU utilization percentage
    targetCPUUtilizationPercentage: 70
    # -- Target memory utilization percentage
    targetMemoryUtilizationPercentage: 80
    # -- Scaling behavior configuration
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 10
            periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 15
          - type: Pods
            value: 4
            periodSeconds: 15
        selectPolicy: Max

  # -- Pod disruption budget
  pdb:
    # -- Enable PDB
    enabled: false
    # -- Minimum available pods (mutually exclusive with maxUnavailable)
    minAvailable: 1
    # -- Maximum unavailable pods
    # maxUnavailable: 1

  # -- Pod anti-affinity configuration
  podAntiAffinity:
    # -- Enable pod anti-affinity (spreads pods across nodes)
    enabled: false
    # -- Anti-affinity type: "soft" (preferred) or "hard" (required)
    type: soft
    # -- Topology key for anti-affinity
    topologyKey: kubernetes.io/hostname

  # -- Resource limits and requests
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 100m
      memory: 256Mi

  # -- Liveness probe configuration
  livenessProbe:
    httpGet:
      path: /api/health
      port: http
    initialDelaySeconds: 10
    periodSeconds: 30

  # -- Readiness probe configuration
  readinessProbe:
    httpGet:
      path: /api/health
      port: http
    initialDelaySeconds: 5
    periodSeconds: 10

  # -- Environment variables (non-secret)
  env:
    SIBYL_SERVER_HOST: "0.0.0.0"
    SIBYL_SERVER_PORT: "3334"
    SIBYL_ENVIRONMENT: "production"
    SIBYL_LLM_PROVIDER: "anthropic"
    SIBYL_LLM_MODEL: "claude-haiku-4-5"
    SIBYL_EMBEDDING_MODEL: "text-embedding-3-small"
    SIBYL_EMBEDDING_DIMENSIONS: "1536"

  # -- Reference to existing secret for sensitive env vars
  # Must contain: SIBYL_JWT_SECRET, SIBYL_OPENAI_API_KEY, SIBYL_ANTHROPIC_API_KEY
  existingSecret: ""

  # -- Database connection settings
  # Option 1: Use CNPG-generated secret (recommended)
  #   Set existingSecret to the CNPG app secret (e.g., "sibyl-postgres-app")
  #   All connection values (host, port, dbname, username, password) are pulled automatically
  # Option 2: Manual configuration
  #   Leave existingSecret empty and set host, port, database, user manually
  #   Password must be in a separate secret
  database:
    # -- Reference to CNPG-generated secret (contains host, port, dbname, username, password)
    # When set, all other database values are ignored
    existingSecret: ""
    # -- PostgreSQL host (only used if existingSecret is empty)
    host: "postgres"
    # -- PostgreSQL port (only used if existingSecret is empty)
    port: "5432"
    # -- PostgreSQL database name (only used if existingSecret is empty)
    database: "sibyl"
    # -- PostgreSQL user (only used if existingSecret is empty)
    user: "sibyl"

  # -- FalkorDB connection settings
  falkordb:
    # -- FalkorDB host
    host: "falkordb"
    # -- FalkorDB port
    port: "6379"
    # -- Reference to secret containing SIBYL_FALKORDB_PASSWORD
    existingSecret: ""

  # -- Pod annotations
  podAnnotations: {}

  # -- Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  # -- Container security context
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

  # -- Node selector
  nodeSelector: {}

  # -- Tolerations
  tolerations: []

  # -- Affinity rules (overridden by podAntiAffinity if enabled)
  affinity: {}

# -- Frontend configuration
frontend:
  # -- Enable frontend deployment
  enabled: true

  # -- Number of replicas (ignored if autoscaling is enabled)
  replicaCount: 1

  image:
    # -- Frontend image repository
    repository: ghcr.io/hyperb1iss/sibyl-web
    # -- Image pull policy
    pullPolicy: IfNotPresent
    # -- Image tag (defaults to chart appVersion)
    tag: ""

  # -- Service configuration
  service:
    type: ClusterIP
    port: 3337

  # -- Autoscaling configuration
  autoscaling:
    # -- Enable horizontal pod autoscaler
    enabled: false
    # -- Minimum replicas
    minReplicas: 2
    # -- Maximum replicas
    maxReplicas: 10
    # -- Target CPU utilization percentage
    targetCPUUtilizationPercentage: 70
    # -- Target memory utilization percentage
    targetMemoryUtilizationPercentage: 80
    # -- Scaling behavior configuration
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 10
            periodSeconds: 60

  # -- Pod disruption budget
  pdb:
    # -- Enable PDB
    enabled: false
    # -- Minimum available pods
    minAvailable: 1

  # -- Pod anti-affinity configuration
  podAntiAffinity:
    # -- Enable pod anti-affinity
    enabled: false
    # -- Anti-affinity type: "soft" or "hard"
    type: soft
    # -- Topology key
    topologyKey: kubernetes.io/hostname

  # -- Resource limits and requests
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 50m
      memory: 128Mi

  # -- Liveness probe configuration
  livenessProbe:
    httpGet:
      path: /
      port: http
    initialDelaySeconds: 10
    periodSeconds: 30

  # -- Readiness probe configuration
  readinessProbe:
    httpGet:
      path: /
      port: http
    initialDelaySeconds: 5
    periodSeconds: 10

  # -- Environment variables
  env:
    NODE_ENV: "production"
    NEXT_TELEMETRY_DISABLED: "1"

  # -- Pod annotations
  podAnnotations: {}

  # -- Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  # -- Container security context
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false # Next.js needs write access
    capabilities:
      drop:
        - ALL

  # -- Node selector
  nodeSelector: {}

  # -- Tolerations
  tolerations: []

  # -- Affinity rules (overridden by podAntiAffinity if enabled)
  affinity: {}

# -- Worker configuration (arq job queue processor)
worker:
  # -- Enable worker deployment
  enabled: true

  # -- Number of replicas (ignored if autoscaling is enabled)
  replicaCount: 1

  # -- Autoscaling configuration
  autoscaling:
    # -- Enable horizontal pod autoscaler
    enabled: false
    # -- Minimum replicas
    minReplicas: 1
    # -- Maximum replicas
    maxReplicas: 5
    # -- Target CPU utilization percentage
    targetCPUUtilizationPercentage: 70
    # -- Target memory utilization percentage
    targetMemoryUtilizationPercentage: 80
    # -- Scaling behavior configuration
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 10
            periodSeconds: 60

  # -- Pod disruption budget
  pdb:
    # -- Enable PDB
    enabled: false
    # -- Minimum available pods
    minAvailable: 1

  # -- Pod anti-affinity configuration
  podAntiAffinity:
    # -- Enable pod anti-affinity
    enabled: false
    # -- Anti-affinity type: "soft" or "hard"
    type: soft
    # -- Topology key
    topologyKey: kubernetes.io/hostname

  # -- Resource limits and requests
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 50m
      memory: 128Mi

  # -- Pod annotations
  podAnnotations: {}

  # -- Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  # -- Container security context
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

  # -- Node selector
  nodeSelector: {}

  # -- Tolerations
  tolerations: []

  # -- Affinity rules (overridden by podAntiAffinity if enabled)
  affinity: {}

# -- Ingress configuration (for reference, actual ingress via Kong)
ingress:
  # -- Enable ingress resource creation
  enabled: false
  # -- Ingress class name
  className: "kong"
  # -- Ingress annotations
  annotations: {}
  # -- Ingress hosts
  hosts:
    - host: sibyl.local
      paths:
        - path: /api
          pathType: Prefix
          service: backend
        - path: /
          pathType: Prefix
          service: frontend
  # -- TLS configuration
  tls: []

# -- Service account configuration
serviceAccount:
  # -- Create service account
  create: true
  # -- Service account name
  name: ""
  # -- Service account annotations
  annotations: {}
