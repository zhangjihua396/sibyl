{
  "project": {
    "name": "Security & Permissions",
    "description": "Auth hardening, RBAC, and RLS workstream"
  },
  "epic": {
    "title": "AuthZ hardening + org/project RBAC",
    "description": "Fix auth cohesion issues, close tenant leaks, implement project permissions, and add optional Postgres RLS.",
    "priority": "high"
  },
  "tasks": [
    {
      "priority": "critical",
      "title": "Fix WebSocket org scoping to verify JWT",
      "description": "Stop trusting unverified JWT payloads in WebSocket org scoping. Only derive org_id from verified access tokens; update tests accordingly.",
      "components": ["backend"],
      "labels": ["P0", "security", "tenant-isolation"]
    },
    {
      "priority": "critical",
      "title": "Scope crawler link-graph endpoints to current org",
      "description": "Ensure /api/sources/link-graph and /api/sources/{source_id}/link-graph only operate on sources/chunks within the caller org. Prevent cross-org leakage/contamination; consider restricting to owner/admin.",
      "components": ["backend", "db"],
      "labels": ["P0", "security", "tenant-isolation", "crawler"]
    },
    {
      "priority": "high",
      "title": "Scope crawler link-graph status endpoint to current org",
      "description": "Ensure /api/sources/link-graph/status reports only per-org counts and does not leak source names across organizations.",
      "components": ["backend", "db"],
      "labels": ["P0", "security", "tenant-isolation", "crawler"]
    },
    {
      "priority": "high",
      "title": "Scope crawler sync source endpoint to current org",
      "description": "Ensure POST /api/sources/{source_id}/sync verifies source ownership by org before reading/updating.",
      "components": ["backend", "db"],
      "labels": ["P0", "security", "tenant-isolation", "crawler"]
    },
    {
      "priority": "high",
      "title": "Make org switching rotate refresh tokens (web + CLI)",
      "description": "Fix access/refresh token mismatch when switching orgs (and when creating orgs / accepting invites). After refresh, org context must not revert unexpectedly. Update CLI org switch to persist refresh token too (or redesign refresh semantics).",
      "components": ["backend", "web", "cli"],
      "labels": ["P1", "auth", "ux"]
    },
    {
      "priority": "high",
      "title": "Revoke server-side session on logout",
      "description": "On logout, revoke the session that matches the refresh token (if present) so stolen refresh tokens stop working immediately.",
      "components": ["backend", "db"],
      "labels": ["P1", "auth", "security"]
    },
    {
      "priority": "high",
      "title": "Implement API key scopes + enforcement",
      "description": "Add scope storage to api_keys and enforce scopes in REST + MCP. Ensure MCP tool calls require mcp scope; introduce least-privilege for automation.",
      "components": ["backend", "db", "cli", "mcp"],
      "labels": ["P1", "authz", "security"]
    },
    {
      "priority": "medium",
      "title": "Harden CLI token storage (permissions/keychain)",
      "description": "Write ~/.sibyl/auth.json with restrictive permissions (0600). Optionally add an OS keychain backend (future) for refresh/API keys.",
      "components": ["cli"],
      "labels": ["P2", "security"]
    },
    {
      "priority": "medium",
      "title": "Add Postgres schema for projects + memberships + team grants",
      "description": "Introduce Postgres tables for project RBAC (projects, project_members, team_projects) and enums for project_role + project_visibility.",
      "components": ["db", "backend"],
      "labels": ["P2", "rbac", "permissions"]
    },
    {
      "priority": "medium",
      "title": "Enforce project RBAC on task/epic operations",
      "description": "Ensure task/epic list/create/update respects allowed projects. Support private projects and team-granted access. Apply consistently across REST + MCP.",
      "components": ["backend", "mcp", "cli"],
      "labels": ["P2", "rbac", "permissions"]
    },
    {
      "priority": "low",
      "title": "Add team management APIs and UX",
      "description": "Expose teams + membership + roles in backend and web/cli. Allow granting teams access to projects with a role.",
      "components": ["backend", "web", "cli"],
      "labels": ["P2", "teams", "permissions"]
    },
    {
      "priority": "low",
      "title": "Enable org-level Postgres RLS",
      "description": "Add org-level RLS policies for org-scoped tables. Set request-scoped session vars (app.org_id, app.user_id) in SQLAlchemy for defense-in-depth.",
      "components": ["db", "backend"],
      "labels": ["P3", "rls", "security"]
    },
    {
      "priority": "low",
      "title": "Extend RLS to project-level policies",
      "description": "For project-private resources stored in Postgres, enforce access at DB level by allowed project membership for app.user_id.",
      "components": ["db", "backend"],
      "labels": ["P3", "rls", "permissions"]
    }
  ]
}

