# sibyl-core package tasks
$schema: "https://moonrepo.dev/schemas/project.json"

type: library
language: python
platform: system

tags:
  - python
  - library
  - core

fileGroups:
  sources:
    - "src/**/*.py"
  tests:
    - "tests/**/*.py"
  configs:
    - "pyproject.toml"
    - "moon.yml"

tasks:
  sync:
    command: "uv sync"
    inputs:
      - "@group(configs)"

  lint:
    command: "uv run ruff check src/ tests/"
    deps:
      - "root:sync"
    inputs:
      - "@group(sources)"
      - "@group(tests)"

  format:
    command: "uv run ruff format src/ tests/"
    inputs:
      - "@group(sources)"
      - "@group(tests)"

  fix:
    command: "uv run ruff check --fix src/ tests/ && uv run ruff format src/ tests/"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
    local: true

  fix-all:
    command: "uv run ruff check --fix --unsafe-fixes src/ tests/ && uv run ruff format src/ tests/"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
    local: true

  typecheck:
    command: "uv run pyright src/"
    deps:
      - "root:sync"
    inputs:
      - "@group(sources)"

  test:
    command: "uv run pytest tests/ -v"
    deps:
      - "root:sync"
    inputs:
      - "@group(sources)"
      - "@group(tests)"

  test-cov:
    command: "uv run pytest tests/ --cov=src --cov-report=term-missing --cov-report=xml:coverage.xml"
    deps:
      - "root:sync"
    inputs:
      - "@group(sources)"
      - "@group(tests)"
    outputs:
      - "coverage.xml"

  check:
    deps:
      - "~:lint"
      - "~:typecheck"
      - "~:test"
